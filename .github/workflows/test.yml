# GitHub Actions CI/CD Pipeline
# Automated Test Execution for Trinity HCP Targeting & Segmentation
#
# Triggers:
# - Push to main/develop branches
# - Pull requests
# - Manual trigger (workflow_dispatch)

name: Automated Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allows manual trigger
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox]  # Test on multiple browsers
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install ${{ matrix.browser }}
        playwright install-deps
    
    - name: Create .env file from secrets
      run: |
        echo "APP_URL=${{ secrets.APP_URL }}" >> config/.env
        echo "API_BASE_URL=${{ secrets.API_BASE_URL }}" >> config/.env
        echo "TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL }}" >> config/.env
        echo "TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }}" >> config/.env
        echo "DB_SERVER=${{ secrets.DB_SERVER }}" >> config/.env
        echo "DB_NAME=${{ secrets.DB_NAME }}" >> config/.env
        echo "DB_USER=${{ secrets.DB_USER }}" >> config/.env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> config/.env
        echo "DB_DRIVER=ODBC Driver 17 for SQL Server" >> config/.env
    
    - name: Run Login Positive Tests
      run: |
        pytest tests/ui/test_login.py::test_pos_001_successful_login_with_all_validations \
          --browser=${{ matrix.browser }} \
          --headless \
          -v -s \
          --html=reports/report_${{ matrix.browser }}.html \
          --self-contained-html
      continue-on-error: false
    
    - name: Run All Login Tests
      run: |
        pytest tests/ui/test_login.py \
          --browser=${{ matrix.browser }} \
          --headless \
          -v -s \
          --html=reports/report_all_${{ matrix.browser }}.html \
          --self-contained-html
      continue-on-error: true
    
    - name: Upload Test Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports-${{ matrix.browser }}
        path: |
          reports/
          screenshots/
    
    - name: Upload Screenshots on Failure
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: screenshots-${{ matrix.browser }}-${{ github.run_number }}
        path: reports/screenshots/
    
    - name: Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… Tests completed for ${{ matrix.browser }}. Check artifacts for reports.'
          })
